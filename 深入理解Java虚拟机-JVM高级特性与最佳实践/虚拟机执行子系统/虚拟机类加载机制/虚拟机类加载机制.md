|什么是虚拟机的类加载机制？|
|----|
|1、虚拟机把描述类的数据从class文件加载到内存|
|2、并对数据进行校验、转换解析和初始化|
|3、最终形成可以被虚拟机直接使用的Java类型|



Java语言中类型的加载和连接过程都是在程序运行期间完成的，会在类加载时增加性能开销，但却能为Java程序提供高度的灵活性。Java可以动态扩展的语言特性就是依赖运行期间动态加载和动态连接的特点实现的。

编写一个使用接口的应用程序，可以等到运行时再指定其实际的实现。



类从被加载到虚拟机内存中开始，到卸载出内存结束的整个生命周期：

|类加载的生命周期|
|----|
|加载Loading|
|连接Linking中的验证Verification|
|连接Linking中的准备Preparation|
|连接Linking中的解析Resolution|
|初始化Initialization|
|使用Using|
|卸载Unloading|
|备注：解析有可能在初始化阶段之后再开始，为了支持Java语言的运行时绑定/动态绑定/晚期绑定。|



虚拟机规范规定了有且只有四种情况必须立即对类进行初始化。
```
1、遇到new、getstatic、putstatic、invokestatic这4个字节码指令时，如果类没有进行过初始化，则需要先触发其初始化。
```
|对应的Java代码场景：主动引用|
|----|
|1、使用new关键字实例化对象的时候。|
|2、读取或设置一个类的静态变量的时候，被final修饰已在编译器把结果放入常量池的静态字段除外。|
|3、当初始化一个类的时候，如果发现其父类还没有进行过初始化，则需要先触发其父类的初始化。|
|4、当虚拟机启动时，用户需要指定要执行的主类，也就是main()方法所在类，虚拟机会先初始化该类。|


|非主动引用|
|----|
|对于静态变量，只有直接定义	这个变量的类才会被初始化，通过其子类来引用父类中定义的静态变量，只会触发父类的初始化，不会触发子类的初始化。|
|通过数组定义来引用类，不会触发此类的初始化。数组是由虚拟机自动生成的、直接继承于java.lang.Object的子类，创建动作由字节码指令newarray触发。|
|常量在编译阶段会存入调用类的常量池中，本质上没有直接引用到定义常量的类，因此不会触发定义常量的类的初始化。实际上当前类并没有调用类的符号引用入口，这两个类在编译成class之后就不存在任何联系。|

Sun HotSpot虚拟机设置-XX:+TraceClassLoading查看类加载。


接口中不能使用static{}语句块，但编译器仍然会为接口生成<clinit>()类构造器，用于初始化接口中所定义的成员变量。
一个接口在初始化时，并不要求其父接口全部都完成了初始化，只有真正在使用到父接口的时候，才会被初始化。



|加载阶段|
|----|
|1、通过一个类的全限定名来获取定义此类的二进制字节流。|
|2、将这个字节流所代表的的静态存储结构，转化为方法区的运行时数据结构。|
|3、在Java堆中生成一个代表这个类的java.lang.Class对象，作为方法区这些数据的访问入口。|



|构造器|解释|
|----|----|
|`<clinit>`|类构造器|
|`<init>`|方法构造器|



|从哪里获取二进制字节流？|
|----|
|从zip包中读取，例如jar、ear、war等压缩包中获取|
|从网络中获取，例如applet|
|运行时计算生成，例如动态代理技术，在java.lang.reflect.Proxy中，用了ProxyGenerator.generateProxyClass来为特定接口生成*$Proxy的代理类的二进制字节流。|
|由其他文件生成，例如JSP应用|
|从数据库中读取，例如SAP Netweaver中间件服务器，把程序安装到数据库中完成程序代码在集群建的分发。|

加载阶段是开发期可控性最强的阶段，可以使用系统提供的类加载器完成，也可以由用户自定义的类加载器完成，开发者可以通过自己的类加载器去控制字节流的获取方式。

加载阶段完成后，虚拟机外部的二进制字节流就按照虚拟机所需的格式存储在方法区中，方法区中的数据存储格式由虚拟机实现自定义，虚拟机规范未规定此区域的具体数据结构。
然后在Java堆中实例化一个java.lang.Class类的对象，这个对象将作为程序访问方法区中的这些类型数据的外部接口。


|验证阶段|解释|
|----|----|
|目的|确保class文件的字节流中包含的信息符合当前虚拟机的要求，且不会危害虚拟机自身安全|
|虚拟机规范|若验证输入的字节流不符合class文件存储格式，将抛出java.lang.VerifyError异常或其子异常|




|检验过程|
|----|
|文件格式验证|
|元数据验证|
|字节码验证|
|符号引用验证|

